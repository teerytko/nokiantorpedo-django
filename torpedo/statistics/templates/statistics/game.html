{% extends 'statistics/base.html' %}
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
{% block head_datatables %}
<script type="text/javascript" charset="utf-8">
    var sid = getQueryVariable("sId");
    var hometeam;
    var hometeam_id=0;
    var guestteam;
    var guestteam_id=0;
    var gameTable;

    var guestPlayer;
    var homeGoal;
    var editHomeGoal = false;
    var guestGoal;
    var editGuestGoal = false;
    var homePenalty;
    var editHomePenalty = false;
    var guestPenalty;
    var editGuestPenalty = false;
	var playerquery = '../statistics/rest/player?format=dict&key=id&value=name&sQuery=team__id=='
    var goalquery = "../statistics/rest/goal?format=dlist&sQuery=game__id=="+sid+" and team__id==";
    var penaltyquery = "../statistics/rest/penalty?format=dlist&sQuery=game__id=="+sid+" and team__id==";
    var STATIC_TABLE_LEN = 15;
    function update_data(data)
    {
        var gamedate = data[0][1];
        var gamelocation = data[0][2];
        hometeam = data[0][3];
        if (data[0][4] != '-') { hometeam_id = data[0][4]; }
        guestteam = data[0][5];
        if (data[0][6] != '-') { guestteam_id = data[0][6]; }
        $('#game-info').html(gamedate+' '+gamelocation);
        $('#home-team-info').html('Koti: <a href="team?sId='+hometeam_id+'">'+hometeam+'</a>');
        $('#guest-team-info').html('Vieras: <a href="team?sId='+guestteam_id+'">'+guestteam+'</a>');
    }

    $(document).ready(function() {
        var gameid = getQueryVariable('sId');
        var defaults = {
            "bServerSide": true,
            "bPaginate": false,
            "bInfo": false,
            "bFilter": false,
        }

        gameTable = $('#salibandy_game').dataTable( 
            $.extend(defaults, {
            sAjaxSource: "../statistics/rest/game?format=dlist&sQuery=id=="+gameid,
            aoColumns: [ { "sName": "id", "bVisible": false }, // the first column is invisible
                         { "sClass": "text", "sName": "date"},
                         { "sClass": "text", "sName": "location"},
                         { "sClass": "select", "sName": "home__name" },
                         { "bVisible": false , "sName": "home__id" },
                         { "sClass": "select", "sName": "guest__name"},
                         { "bVisible": false , "sName": "guest__id" },
                         { "sName": "home_goals"},
                         { "sName": "guest_goals"},
                         ],
            fnDrawCallback: function () {
        {%if perms.statistics.change_game %}
                $('#salibandy_game td.text').create_edit(
                      { 'oTable' : gameTable, 
                        'sUpdateUrl': '../statistics/rest/game'})
                $('#salibandy_game td.select').create_select_edit(
                    { oTable : gameTable, 
                      sUpdateUrl: '../statistics/rest/game',
                      sUpdateFieldReplace: {from: '__name', to: '_id'}, 
                      sLoadUrl: '../statistics/rest/team?format=dict&key=id&value=name',
                })
        {% endif %}
                data = gameTable.fnGetData()
                update_data(data);
                homeGoal.fnSettings().sAjaxSource = goalquery+hometeam_id;
                guestGoal.fnSettings().sAjaxSource = goalquery+guestteam_id;
                homePenalty.fnSettings().sAjaxSource = penaltyquery+hometeam_id;
                guestPenalty.fnSettings().sAjaxSource = penaltyquery+guestteam_id;
                homeGoal.fnDraw();
                guestGoal.fnDraw();
                homePenalty.fnDraw();
                guestPenalty.fnDraw();
                
            }
        }) );
        homeGoal = $('#homegoal').dataTable( {
            bServerSide: true,
            bPaginate: false,
            bInfo: false,
            bFilter: false,
            sAjaxSource: goalquery+hometeam_id,
            aaSorting: [[1,'asc']],
            aoColumns: [ { "sName": "id", bVisible: false }, // the first column is invisible
                         { sClass: "text", "sName": "time"},
                         { sClass: "select", "sName": "player__name"},
                         { sClass: "select", "sName": "assisting__name"},
                         { sClass: "text", "sName": "note"},
                         ],
            fnDrawCallback: function() {
                add_static_data(homeGoal, []);
                if (editHomeGoal == true) {
                    $('#homegoal td.text').create_edit(
                          { 'oTable' : homeGoal, 
                            'sUpdateUrl': '../statistics/rest/goal'})
                    $('#homegoal td.select').create_select_edit(
                        { oTable : homeGoal, 
                          sUpdateUrl: '../statistics/rest/goal',
                          sUpdateFieldReplace: {from: '__name', to: '_id'}, 
                          sLoadUrl: playerquery+hometeam_id})
                }
            }
        });
        /* Add a click handler to the rows - this could be used as a callback */
        $("#homegoal tbody").click(function(event) {
            $(homeGoal.fnSettings().aoData).each(function (){
                $(this.nTr).removeClass('row_selected');
            });
            $(event.target.parentNode).addClass('row_selected');
        });
        /* Add a click handler for the delete row */
        $('#delete-homeGoal').click( function() {
            var anSelected = fnGetSelected( homeGoal );
            var sId = homeGoal.fnGetData(homeGoal.fnGetPosition(anSelected[0]))[0]
            delete_datarow(homeGoal, 'goal', sId);
        } );
        /* Add a click handler for the delete row */
        $('#add-homeGoal').click( function() {
            add_datarow(homeGoal, 'goal', {'team' : hometeam_id,
                                           'game' : sid,
                                           'time' : '00:00:00'});
        } );
        /* Add a click handler for the delete row */
        $('#edit-homeGoal').click( function() {
            if (editHomeGoal == false) {
                editHomeGoal = true
                $('#edit-homeGoal').html('Lopeta muokkaus')
                homeGoal.fnDraw();    
            }
            else {
                editHomeGoal = false;
                $('#edit-homeGoal').html('Muokkaa');
                homeGoal.fnDraw();
            }    
        });
        guestGoal = $('#guestgoal').dataTable( {
            bServerSide: true,
            bPaginate: false,
            bInfo: false,
            bFilter: false,
            sAjaxSource: goalquery+guestteam_id,
            aaSorting: [[1,'asc']],
            aoColumns: [ { "sName": "id", bVisible: false }, // the first column is invisible
                         { sClass: "text", "sName": "time"},
                         { sClass: "select", "sName": "player__name"},
                         { sClass: "select", "sName": "assisting__name"},
                         { sClass: "text", "sName": "note"},
                         ],
            fnDrawCallback: function() {
                add_static_data(guestGoal, []);
                if (editGuestGoal == true) {
                    $('#guestgoal td.text').create_edit(
                          { 'oTable' : guestGoal, 
                            'sUpdateUrl': '../statistics/rest/goal'})
                    $('#guestgoal td.select').create_select_edit(
                        { oTable : guestGoal, 
                          sUpdateUrl: '../statistics/rest/goal',
                          sUpdateFieldReplace: {from: '__name', to: '_id'}, 
                          sLoadUrl: playerquery+guestteam_id})
                }
            }
        });
        /* Add a click handler to the rows - this could be used as a callback */
        $("#guestgoal tbody").click(function(event) {
            $(guestGoal.fnSettings().aoData).each(function (){
                $(this.nTr).removeClass('row_selected');
            });
            $(event.target.parentNode).addClass('row_selected');
        });
        /* Add a click handler for the delete row */
        $('#delete-guestGoal').click( function() {
            var anSelected = fnGetSelected( guestGoal );
            var sId = guestGoal.fnGetData(guestGoal.fnGetPosition(anSelected[0]))[0]
            delete_datarow(guestGoal, 'goal', sId);
        } );
        /* Add a click handler for the delete row */
        $('#add-guestGoal').click( function() {
            add_datarow(guestGoal, 'goal', 
                                  {'team' : guestteam_id, 
                                   'game' : sid,
                                   'time' : '00:00:00'});
        } );
        /* Add a click handler for the delete row */
        $('#edit-guestGoal').click( function() {
            if (editGuestGoal == false) {
                editGuestGoal = true
                $('#edit-guestGoal').html('Lopeta muokkaus')
                guestGoal.fnDraw();    
            }
            else {
                editGuestGoal = false;
                $('#edit-guestGoal').html('Muokkaa');
                guestGoal.fnDraw();
            }    
        });
        homePenalty = $('#homepenalty').dataTable( {
            bServerSide: true,
            bPaginate: false,
            bInfo: false,
            bFilter: false,
            sAjaxSource: penaltyquery+hometeam_id,
            aaSorting: [[1,'asc']],
            aoColumns: [ { sName: 'id', bVisible: false }, // the first column is invisible
                         { sClass: "text", "sName": "time"},
                         { sClass: "text", "sName": "length"},
                         { sClass: "select", "sName": "player__name"},
                         { sClass: "text", "sName": "reason"},
                         ],
            fnDrawCallback: function() {
                add_static_data(homePenalty, []);
                if (editHomePenalty == true) {
                    $('#homepenalty td.text').create_edit(
                          { 'oTable' : homePenalty, 
                            'sUpdateUrl': '../statistics/rest/penalty'})
                    $('#homepenalty td.select').create_select_edit(
                        { oTable : homePenalty, 
                          sUpdateUrl: '../statistics/rest/penalty',
                          sUpdateFieldReplace: {from: '__name', to: '_id'}, 
                          sLoadUrl: playerquery+hometeam_id})
                }
            }
        });
        /* Add a click handler to the rows - this could be used as a callback */
        $("#homepenalty tbody").click(function(event) {
            $(homePenalty.fnSettings().aoData).each(function (){
                $(this.nTr).removeClass('row_selected');
            });
            $(event.target.parentNode).addClass('row_selected');
        });
        /* Add a click handler for the delete row */
        $('#delete-homePenalty').click( function() {
            var anSelected = fnGetSelected( homePenalty );
            var sId = homePenalty.fnGetData(homePenalty.fnGetPosition(anSelected[0]))[0]
            delete_datarow(homePenalty, 'penalty', sId);
        } );
        /* Add a click handler for the delete row */
        $('#add-homePenalty').click( function() {
            add_datarow(homePenalty, 'penalty', {'team' : hometeam_id,
                                                 'game' : sid,
                                                 'time' : '00:00:00',
                                                 'length' : '00:02:00'});
        } );
        /* Add a click handler for the delete row */
        $('#edit-homePenalty').click( function() {
            if (editHomePenalty == false) {
                editHomePenalty = true
                $('#edit-homePenalty').html('Lopeta muokkaus')
                homePenalty.fnDraw();    
            }
            else {
                editHomePenalty = false;
                $('#edit-homePenalty').html('Muokkaa');
                homePenalty.fnDraw();
            }    
        });

        guestPenalty = $('#guestpenalty').dataTable( {
            bServerSide: true,
            bPaginate: false,
            bInfo: false,
            bFilter: false,
            sAjaxSource: penaltyquery+guestteam_id,
            aaSorting: [[1,'asc']],
            aoColumns: [ { sName: 'id', bVisible: false }, // the first column is invisible
                         { sClass: "text", "sName": "time"},
                         { sClass: "text", "sName": "length"},
                         { sClass: "select", "sName": "player__name"},
                         { sClass: "text", "sName": "reason"},
                         ],
            fnDrawCallback: function() {
                add_static_data(guestPenalty, []);
                if (editHomePenalty == true) {
                    $('#guestpenalty td.text').create_edit(
                          { 'oTable' : guestPenalty, 
                            'sUpdateUrl': '../statistics/rest/penalty',
                            'sUpdateMethod': 'PUT'})
                    $('#guestpenalty td.select').create_select_edit(
                        { 'oTable' : guestPenalty, 
                          'sUpdateUrl': '../statistics/rest/penalty',
                          sUpdateFieldReplace: {from: '__name', to: '_id'}, 
                          'sLoadUrl': playerquery+guestteam_id})
                }
            }
        });
        /* Add a click handler to the rows - this could be used as a callback */
        $("#guestpenalty tbody").click(function(event) {
            $(guestPenalty.fnSettings().aoData).each(function (){
                $(this.nTr).removeClass('row_selected');
            });
            $(event.target.parentNode).addClass('row_selected');
        });
        /* Add a click handler for the delete row */
        $('#delete-guestPenalty').click( function() {
            var anSelected = fnGetSelected( guestPenalty );
            var sId = guestPenalty.fnGetData(guestPenalty.fnGetPosition(anSelected[0]))[0]
            delete_datarow(guestPenalty, 'penalty', sId);
        } );
        /* Add a click handler for the delete row */
        $('#add-guestPenalty').click( function() {
            add_datarow(guestPenalty, 'penalty', {'team' : guestteam_id, 
                                                  'game' : sid,
                                                  'time' : '00:00:00',
                                                  'length' : '00:02:00'});
        } );
        /* Add a click handler for the delete row */
        $('#edit-guestPenalty').click( function() {
            if (editHomePenalty == false) {
                editHomePenalty = true
                $('#edit-guestPenalty').html('Lopeta muokkaus')
                guestPenalty.fnDraw();
            }
            else {
                editHomePenalty = false;
                $('#edit-guestPenalty').html('Muokkaa');
                guestPenalty.fnDraw();
            }    
        });

    });

</script>
{% endblock %}

{% block center %}
<article id="fullmaincolumn">

<div id="datatables">
<div id="container" style="width: 800px;">
    <div class="full_width big">
        <i><div id="game-info"></div></i>
    </div>
    
    <p>Peli tietojen täyyttö</p>
    <a href="games">Takaisin peleihin</a>
    <div id="dynamic">  
    <table class="display">
    <tr><td colspan="2">
        <!-- pelin perustiedot -->
        <table cellpadding="0" cellspacing="0" border="0" width="100%" id="salibandy_game">
        <thead>
            <tr>
                <th width="0%">Id</th>
                <th width="20%">Aika</th>
                <th width="15%">Paikka</th>
                <th width="25%">Koti</th>
                <th width="25%">Koti</th>
                <th width="25%">Vieras</th>
                <th width="25%">Vieras</th>
                <th width="25%">Koti maalit</th>
                <th width="25%">Vieras maalit</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td colspan="9"></td>
            </tr>
        </tbody>
        </table>
    </td></tr>
    <tr><td>
 
        <!--<table cellpadding="0" cellspacing="0" border="0" id="content">-->
        <tr>
            <th width="50%">Maalit</th>
            <th width="50%">Rangaistukset</th>
        </tr>
        <tr>
            <td colspan="2"><div id="home-team-info"></div></td>
        </tr>
        {% if perms.statistics.change_game %}
        <tr>
            <td colspan="1">
                <a href="javascript:void(0);" id="add-homeGoal" style="color:black">Lisää</a> / 
                <a href="javascript:void(0);" id="delete-homeGoal" style="color:black">Poista</a> /
                <a href="javascript:void(0);" id="edit-homeGoal" style="color:black">Muokkaa</a>
            </td>
            <td colspan="1">
                <a href="javascript:void(0);" id="add-homePenalty" style="color:black">Lisää</a> / 
                <a href="javascript:void(0);" id="delete-homePenalty" style="color:black">Poista</a> /
                <a href="javascript:void(0);" id="edit-homePenalty" style="color:black">Muokkaa</a>
            </td>
        </tr>
        {% endif %}
        <tr>
            <td>
            <table cellpadding="0" cellspacing="0" border="0" class="display" id="homegoal">
                <thead>
                    <tr>
                        <th width="0%">Id</th>
                        <th width="10%">Aika</th>
                        <th width="40%">Tekijä</th>
                        <th width="40%">Syöttäjä</th>
                        <th width="10%">Koodi</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">null</td>
                    </tr>
                </tbody>
            </table>
            </td>    
            <td>
            <table cellpadding="0" cellspacing="0" border="0" class="display" id="homepenalty">
                <thead>
                    <tr>
                        <th width="0%">Id</th>
                        <th width="10%">Aika</th>
                        <th width="10%">Kesto</th>
                        <th width="50%">Pelaaja</th>
                        <th width="5%">Syy</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">null</td>
                    </tr>
                </tbody>
            </table>
            </td>    
        </tr>
        <tr>
            <td colspan="2"><div id="guest-team-info"></div></td>
        </tr>
        {% if perms.statistics.change_game %}
        <tr>
            <td colspan="1">
                <a href="javascript:void(0);" id="add-guestGoal" style="color:black">Lisää</a> / 
                <a href="javascript:void(0);" id="delete-guestGoal" style="color:black">Poista</a> /
                <a href="javascript:void(0);" id="edit-guestGoal" style="color:black">Muokkaa</a>
            </td>
            <td colspan="1">
                <a href="javascript:void(0);" id="add-guestPenalty" style="color:black">Lisää</a> / 
                <a href="javascript:void(0);" id="delete-guestPenalty" style="color:black">Poista</a> /
                <a href="javascript:void(0);" id="edit-guestPenalty" style="color:black">Muokkaa</a>
            </td>
        </tr>
        {% endif %}
        <tr>
            <td>
            <table cellpadding="0" cellspacing="0" border="0" class="display" id="guestgoal">
                <thead>
                    <tr>
                        <th width="0%">Id</th>
                        <th width="10%">Aika</th>
                        <th width="30%">Tekijä</th>
                        <th width="30%">Syöttäjä</th>
                        <th width="10%">Koodi</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">null</td>
                    </tr>
                </tbody>
            </table>
            </td>    
            <td>
            <table cellpadding="0" cellspacing="0" border="0" class="display" id="guestpenalty">
                <thead>
                    <tr>
                        <th width="0%">Id</th>
                        <th width="10%">Aika</th>
                        <th width="10%">Kesto</th>
                        <th width="50%">Pelaaja</th>
                        <th width="5%">Syy</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="5">null</td>
                    </tr>
                </tbody>
            </table>
            </td>    
        </tr>
        <!--</table> -->
        
        </td>    
    </tr>
    </table>
</div>
</div>
</div>
</article>
{% endblock %}

